<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wiatec.blive.orm.dao.LiveChannelDao">

    <sql id="select">
        SELECT id, userId, available, rating, title, message, stream_id, url, rtmp_url, rtmp_key,
            playUrl, preview, category, type, price, link, startTime, create_time, modify_time
        FROM bvision_channel_live
    </sql>

    <select id="selectAllAvailable" resultType="com.wiatec.blive.orm.pojo.LiveChannelInfo">
        <include refid="select"/>
        WHERE available=1
        ORDER BY startTime DESC
    </select>

    <select id="selectAllAvailableWithUserInfo" resultType="com.wiatec.blive.orm.pojo.LiveChannelInfo">
        SELECT bvision_channel_live.id, bvision_channel_live.userId, bvision_channel_live.available,
        bvision_channel_live.rating, bvision_channel_live.title, bvision_channel_live.message,
        bvision_channel_live.playUrl, bvision_channel_live.preview, bvision_channel_live.category,
        bvision_channel_live.type, bvision_channel_live.price, bvision_channel_live.link,
        bvision_channel_live.startTime, bvision_channel_live.create_time, bvision_channel_live.modify_time,
        auth_register_user.username username, auth_register_user.icon userIcon, auth_register_user.level level
        FROM bvision_channel_live, auth_register_user
        WHERE bvision_channel_live.userId = auth_register_user.id AND bvision_channel_live.available = 1
        ORDER BY bvision_channel_live.startTime DESC
    </select>

    <select id="searchByLikeTitle" resultType="com.wiatec.blive.orm.pojo.LiveChannelInfo">
        <include refid="select"/>
        WHERE available=1 AND title LIKE concat('%',#{title},'%')
        ORDER BY startTime DESC
    </select>

    <select id="selectOneByUserId" resultType="com.wiatec.blive.orm.pojo.LiveChannelInfo">
       <include refid="select"/>
        WHERE userId=#{userId}
    </select>

    <select id="countByUserId" resultType="java.lang.Integer">
      SELECT COUNT(1) count FROM bvision_channel_live
      WHERE userId=#{userId}
    </select>

    <select id="selectUserIdByStreamId" resultType="java.lang.Integer">
        SELECT userId FROM bvision_channel_live
        WHERE stream_id = #{streamId}
    </select>

    <update id="insertChannel">
        INSERT IGNORE INTO bvision_channel_live (title, stream_id, url, rtmp_url, rtmp_key, playUrl,
                                                 preview, category, userId, modify_time)
        VALUES (#{title}, #{streamId}, #{url}, #{rtmpUrl}, #{rtmpKey}, #{playUrl}, '1', '1', #{userId}, now())
    </update>

    <update id="updateChannel">
        UPDATE IGNORE bvision_channel_live
        SET stream_id = #{streamId}, url = #{url}, rtmp_url = #{rtmpUrl}, rtmp_key = #{rtmpKey}, playUrl = #{playUrl},
        modify_time = now()
        WHERE userId=#{userId}
    </update>

    <update id="updateTitleAndMessageByUserId">
        UPDATE bvision_channel_live
        SET title=#{title}, message=#{message}, modify_time = now()
        WHERE userId=#{userId}
    </update>

    <update id="updateTitleByUserId">
        UPDATE bvision_channel_live
        SET title=#{title}, modify_time = now()
        WHERE userId=#{userId}
    </update>

    <update id="updateMessageByUserId">
        UPDATE bvision_channel_live
        SET message=#{message}, modify_time = now()
        WHERE userId=#{userId}
    </update>

    <update id="updatePriceByUserId">
        UPDATE bvision_channel_live
        SET price=#{price}, modify_time = now()
        WHERE userId=#{userId}
    </update>

    <update id="updateLinkByUserId">
        UPDATE bvision_channel_live
        SET link=#{link}, modify_time = now()
        WHERE userId=#{userId}
    </update>

    <update id="updateAllSettingByUserId">
        UPDATE bvision_channel_live
        SET title=#{title}, message=#{message}, link=#{link}, price=#{price}, rating = #{rating},
            modify_time = now()
        WHERE userId=#{userId}
    </update>

    <update id="updateAvailableByUserId">
        UPDATE bvision_channel_live
        SET available = 1, startTime = now(), modify_time = now()
        WHERE userId=#{userId}
    </update>

    <update id="updateUnavailableByUserId">
        UPDATE bvision_channel_live
        SET available = 0, startTime = now(), modify_time = now()
        WHERE userId=#{userId}
    </update>

    <update id="updatePreviewByUserId" parameterType="com.wiatec.blive.orm.pojo.LiveChannelInfo">
        UPDATE bvision_channel_live
        SET preview=#{preview}, modify_time = now()
        WHERE userId=#{userId}
    </update>

</mapper>