<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wiatec.blive.orm.dao.LiveChannelDao">

    <sql id="select">
        SELECT id, user_id, available, rating, title, message, stream_id, push_url, rtmp_url, rtmp_key,
            play_url, preview, category, type, price, link, live_time, create_time, modify_time
        FROM bvision_channel_live
    </sql>

    <select id="selectAllAvailable" resultType="com.wiatec.blive.orm.pojo.ChannelInfo">
        <include refid="select"/>
        WHERE available=1
        ORDER BY startTime DESC
    </select>

    <select id="selectAllAvailableWithUserInfo" resultType="com.wiatec.blive.orm.pojo.ChannelInfo">
        SELECT bvision_channel_live.id, bvision_channel_live.user_id, bvision_channel_live.available,
        bvision_channel_live.rating, bvision_channel_live.title, bvision_channel_live.message,
        bvision_channel_live.play_url, bvision_channel_live.preview, bvision_channel_live.category,
        bvision_channel_live.type, bvision_channel_live.price, bvision_channel_live.link,
        bvision_channel_live.live_time, bvision_channel_live.create_time, bvision_channel_live.modify_time,
        auth_register_user.username username, auth_register_user.icon userIcon, auth_register_user.level level
        FROM bvision_channel_live, auth_register_user
        WHERE bvision_channel_live.user_id = auth_register_user.id AND bvision_channel_live.available = 1
        ORDER BY bvision_channel_live.live_time DESC
    </select>

    <select id="searchByLikeTitle" resultType="com.wiatec.blive.orm.pojo.ChannelInfo">
        <include refid="select"/>
        WHERE available=1 AND title LIKE concat('%',#{title},'%')
        ORDER BY startTime DESC
    </select>

    <select id="selectOneByUserId" resultType="com.wiatec.blive.orm.pojo.ChannelInfo">
       <include refid="select"/>
        WHERE user_id = #{userId}
    </select>

    <select id="countByUserId" resultType="java.lang.Integer">
      SELECT COUNT(1) count FROM bvision_channel_live
      WHERE user_id=#{userId}
    </select>

    <select id="selectUserIdByStreamId" resultType="java.lang.Integer">
        SELECT user_id FROM bvision_channel_live
        WHERE stream_id = #{streamId}
    </select>

    <update id="insertChannel">
        INSERT IGNORE INTO bvision_channel_live (title, stream_id, push_url, rtmp_url, rtmp_key, play_url,
                                                 preview, category, user_id, modify_time)
        VALUES (#{title}, #{streamId}, #{pushUrl}, #{rtmpUrl}, #{rtmpKey}, #{playUrl}, '1', '1', #{userId}, now())
    </update>

    <update id="updateChannel">
        UPDATE IGNORE bvision_channel_live
        SET stream_id = #{streamId}, push_url = #{pushUrl}, rtmp_url = #{rtmpUrl}, rtmp_key = #{rtmpKey}, play_url = #{playUrl},
        modify_time = now()
        WHERE user_id=#{userId}
    </update>

    <update id="updateTitleAndMessageByUserId">
        UPDATE bvision_channel_live
        SET title=#{title}, message=#{message}, modify_time = now()
        WHERE user_id=#{userId}
    </update>

    <update id="updateTitleByUserId">
        UPDATE bvision_channel_live
        SET title=#{title}, modify_time = now()
        WHERE user_id=#{userId}
    </update>

    <update id="updateMessageByUserId">
        UPDATE bvision_channel_live
        SET message=#{message}, modify_time = now()
        WHERE user_id=#{userId}
    </update>

    <update id="updatePriceByUserId">
        UPDATE bvision_channel_live
        SET price=#{price}, modify_time = now()
        WHERE user_id=#{userId}
    </update>

    <update id="updateLinkByUserId">
        UPDATE bvision_channel_live
        SET link=#{link}, modify_time = now()
        WHERE user_id=#{userId}
    </update>

    <update id="updateAllSettingByUserId">
        UPDATE bvision_channel_live
        SET title=#{title}, message=#{message}, link=#{link}, price=#{price}, rating = #{rating},
            modify_time = now()
        WHERE user_id=#{userId}
    </update>

    <update id="updateAvailableByUserId">
        UPDATE bvision_channel_live
        SET available = 1, live_time = now(), modify_time = now()
        WHERE user_id=#{userId}
    </update>

    <update id="updateUnavailableByUserId">
        UPDATE bvision_channel_live
        SET available = 0, modify_time = now()
        WHERE user_id=#{userId}
    </update>

    <update id="updatePreviewByUserId" parameterType="com.wiatec.blive.orm.pojo.ChannelInfo">
        UPDATE bvision_channel_live
        SET preview=#{preview}, modify_time = now()
        WHERE user_id=#{userId}
    </update>

</mapper>